#!/usr/bin/env python3

import os
import sys
import time

from os import path
from sys import stderr, argv
from subprocess import Popen, PIPE
from shutil import copyfile

from config import configs
from cmd import run_cmd

TEST_SCRIPT = 'fragmentation.redis'

def slurp(file_name):
    with open(file_name, 'r') as f:
        return f.read().strip()


def get_pss(pid, stat = 'Pss'):
    memory = slurp('/proc/%d/smaps_rollup' % pid)
    lines = memory.splitlines()
    def get_stat(stat_name):
        line = [l for l in lines if l.startswith(stat + ':')][0]
        return float(line.split()[1])/1024.0

    rss = get_stat('Pss')
    pss = get_stat('Pss')

    print('\trss:%8.2f MB' % rss)
    print('\tpss:%8.2f MB' % pss)
    return get_stat(pss)


def main():
    '''
    Given a file containing commands, run them against each
    redis-server, recording memory usage.
    '''
    root_dir = os.getcwd()

    tool = lambda tool, config: path.join(root_dir, 'bin', '%s-%s' % (tool, config))

    # parse args

    redis_cli = tool('redis-cli', 'libc')

    for config in configs:
        if config.skip:
            print('skip test for %s' % (config.name,))
            continue

        server = tool('redis-server', config.name)
        server_cmd = run_cmd('%s redis.conf' % server)

        time.sleep(.1) # sleep for 100 ms to give server time to start

        client = run_cmd('cat %s | %s' % (TEST_SCRIPT, redis_cli)).join()

        pss = get_pss(server_cmd.pid)

        if config.defrag:
            print('should defrag + re-grab pss')

        server_cmd.end()
        server_cmd.join()

        print('done test for %s (%.2f MB)' % (config.name, pss))
    

if __name__ == '__main__':
    sys.exit(main())
